# Data Model — архитектурная модель данных

> Этот документ собирает ключевые сущности системы в единую картину:
> связи между ними, ограничения, разделение на персистентные и транзиентные.
>
> Определения терминов — в glossary.md.
> Ответственности компонентов, работающих с этими сущностями — в components.md.
>
> Уровень детализации: сущности, связи, инварианты.
> Точные схемы хранения и форматы сериализации — решения реализации.

---

## 1. Связи между сущностями

```mermaid
erDiagram
    Team ||--o{ User : "содержит"
    User ||--|| Dialogue : "ведёт"
    User ||--|| DialogueState : "имеет"
    Dialogue ||--o{ Message : "упорядоченная последовательность"
    Message ||--o{ Attachment : "опционально"
    ProcessingAgent ||--|| AgentState : "имеет"
```

Сущности, не имеющие прямых связей с другими:
- **TraceEvent** — самодостаточная запись; содержит полные данные,
  а не ссылки на другие сущности
- **BusMessage** — единица межкомпонентной коммуникации;
  персистентен через EventBus → Storage

---

## 2. Сущности

### Team

Группа Users, работающих в общем контексте.

**Содержит:** идентификатор, набор Users.

---

### User

Участник Team, ведущий Dialogue с системой.

**Содержит:** идентификатор, принадлежность к Team.

**Связи:** входит в один Team, имеет один Dialogue, имеет один DialogueState.

---

### Dialogue

Непрерывный диалог между User и AI-ассистентом.

**Содержит:** идентификатор, ссылка на User,
упорядоченная последовательность Messages.

**Инвариант:** один User — один Dialogue.

---

### Message

Одна реплика внутри Dialogue.

**Содержит:** роль (user, assistant, system), текстовое содержимое,
опциональные Attachments, временна́я метка.

**Связи:** принадлежит одному Dialogue, может иметь Attachments.

---

### Attachment

Опциональное дополнение к Message.

**Содержит:** тип (файл, изображение, аудио и т.д.), данные или ссылка.

**Связи:** принадлежит одному Message.

---

### DialogueState

Персистентное состояние Dialogue, достаточное для восстановления
DialogueBuffer при перезапуске системы.

**Содержит:** ссылка на User/Dialogue, граница публикации —
временна́я метка последнего Message, опубликованного в EventBus.
Всё, что в Dialogue после этой метки — ещё не опубликовано.

DialogueBuffer — не отдельная хранимая структура, а вычисляемый
подмассив Messages: от границы публикации до последнего Message.

**Инвариант:** один User — один DialogueState.

---

### AgentState

Персистентное состояние ProcessingAgent.

**Содержит:** идентификатор агента, key-value данные,
SGR-трейсы (логи рассуждений) в формате JSON.

**Инвариант:** каждый агент хранит состояние изолированно;
агенты не имеют доступа к состоянию друг друга.

---

### BusMessage

Единица межкомпонентной коммуникации в EventBus.

**Содержит:** Topic (input / processed / output),
типизированный Payload, метаданные (id, timestamp, source).

**Персистентность:** BusMessages сохраняются в Storage через EventBus.
Возможен TTL для ограничения объёма хранения.

**Payload варьируется по Topic:**
- input — фрагмент диалога (Messages из буфера)
- processed — результат обработки (структура зависит от агента)
- output — содержимое для доставки пользователю

---

### TraceEvent

Единичная запись наблюдаемости.

**Содержит:** тип события, временна́я метка, актор (кто породил),
данные для отображения (полные, не ссылки).

**Самодостаточность:** TraceEvent содержит всю информацию,
необходимую для отображения в VS UI. Tracker вкладывает
полные данные (текст сообщений, SGR-трейсы, содержимое output),
а не идентификаторы для последующего разрешения.

**Append-only:** TraceEvents только добавляются, не модифицируются.

---

## 3. Персистентность

| Сущность | Хранение | Примечание |
|----------|----------|------------|
| Team, User | Storage (SQLite) | Конфигурационные данные |
| Message | Storage | Все реплики всех Dialogues |
| Attachment | Storage | Данные или ссылки |
| DialogueState | Storage | Для восстановления буфера |
| AgentState | Storage | Для восстановления агентов |
| TraceEvent | Storage | Append-only, для VS UI |
| BusMessage | Storage | Персистентен через EventBus; возможен TTL |
| DialogueBuffer | Вычисляемый | Подмассив Messages, определяемый границей из DialogueState |
| Подписки EventBus | В памяти | Пересоздаются при bootstrap |

---

## 4. Ключевые инварианты

- Один User принадлежит одному Team
- Один User имеет один Dialogue и один DialogueState
- Messages внутри Dialogue упорядочены
- AgentState изолирован: агенты не разделяют состояние
- TraceEvents — append-only, самодостаточны (полные данные, не ссылки)
- BusMessages персистентны через EventBus → Storage (возможен TTL)

---

## 5. Открытые вопросы

- **Ротация TraceEvents.** TraceEvents содержат полные данные,
  объём растёт. Нужна ли ротация или временно́е окно для MVP?
  (Вопрос поднят в visualization/overview.md, раздел 7.)
