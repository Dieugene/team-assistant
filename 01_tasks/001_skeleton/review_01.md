# Review отчет: Сквозной скелет (Task 001)

## Общая оценка

**Статус:** ⚠️ Требуется доработка

**Краткий вывод:** Реализация сквозного скелета выполнена на высоком уровне. Все основные компоненты реализованы, данные проходят полный цикл от SIM до VS UI. Однако есть критические проблемы: отсутствие unit-тестов и ряд опечаток в коде, которые могут вызвать проблемы при работе. После исправления этих проблем реализация может быть принята.

## Проверка соответствия спецификации

### Acceptance Criteria (из task_brief_01.md)

- [x] **AC-1:** Application bootstrap запускает все компоненты Core в правильном порядке ✅
- [x] **AC-2:** SIM отправляет Messages через HTTP API (3 VirtualUsers, hardcoded сценарий) ✅
- [x] **AC-3:** DialogueAgent принимает Message, генерирует ответ через LLM, сохраняет в Storage ✅
- [x] **AC-4:** DialogueBuffer накапливает Messages и публикует в EventBus по таймауту (5с) ✅
- [x] **AC-5:** EventBus доставляет BusMessages подписчикам и персистирует их в Storage ✅
- [x] **AC-6:** ProcessingAgent (echo) получает input, публикует output ✅
- [x] **AC-7:** OutputRouter получает output, пересылает в DialogueAgent для доставки ✅
- [x] **AC-8:** Tracker записывает TraceEvents через оба канала (подписка + track()) ✅
- [x] **AC-9:** HTTP API отдает TraceEvents по polling ✅
- [x] **AC-10:** VS UI отображает Timeline с TraceEvents (новые сверху) ✅
- [x] **AC-11:** POST /api/control/reset очищает данные ✅
- [ ] **AC-12:** Unit-тесты для каждого компонента ❌
- [x] **AC-13:** Интеграционный тест: SIM → Core → VS UI (end-to-end flow) ✅

**Итого по AC:** 12/13 выполнены (92%)

### Технические критерии (из analysis_01.md)

- [x] **TC-1:** Все модели реализованы как dataclasses с корректными типами ✅
- [x] **TC-2:** Storage создает таблицы, сохраняет/читает сущности ✅
- [x] **TC-3:** EventBus доставляет BusMessages, персистит ✅
- [x] **TC-4:** Tracker создает TraceEvents через оба канала ✅
- [x] **TC-5:** LLMProvider возвращает ответы (требуется API key) ✅
- [x] **TC-6:** DialogueAgent обрабатывает, буферизует, публикует по таймауту ✅
- [x] **TC-7:** EchoAgent подписан на INPUT, публикует OUTPUT ✅
- [x] **TC-8:** OutputRouter пересылает в DialogueAgent ✅
- [x] **TC-9:** HTTP API отвечает на эндпоинты ✅
- [x] **TC-10:** SIM отправляет сообщения, логирует ✅
- [x] **TC-11:** VS UI отображает Timeline ✅
- [x] **TC-12:** Application.start() запускает компоненты ✅
- [x] **TC-13:** Application.reset() очищает данные ✅
- [ ] **TC-14:** Unit-тесты покрывают все компоненты (минимум 70%) ❌
- [x] **TC-15:** Интеграционный тест создан ✅
- [x] **TC-16:** TraceEvents записываются и видны в VS UI ✅

**Итого по TC:** 15/16 выполнены (94%)

### Интерфейсы и контракты

#### IStorage - ✅ Соответствие интерфейса
- Все методы из `IStorage` протокола реализованы
- Параметризованные запросы используются правильно
- UUID генерация корректная

#### IEventBus - ✅ Соответствие интерфейса
- Pub/sub реализован через `dict[Topic, list[Handler]]`
- `publish()` вызывает подписчиков параллельно через `asyncio.gather()`
- Персистентность в Storage реализована

#### ITracker - ✅ Соответствие интерфейса
- Два канала работают: подписка на EventBus + метод `track()`
- TraceEvents создаются с полными данными

#### ILLMProvider - ✅ Соответствие интерфейса
- Использует Anthropic AsyncClient
- Метод `complete()` соответствует спецификации
- Ошибки пробрасываются вверх

#### IDialogueAgent - ✅ Соответствие интерфейса
- Все методы реализованы
- Буферизация работает через фоновый таймер (5 секунд)
- LLM вызовы интегрированы

#### IProcessingAgent - ✅ Соответствие интерфейса
- EchoAgent реализует интерфейс корректно
- Подписка на EventBus в методе `start()`

#### IProcessingLayer - ✅ Соответствие интерфейса
- Регистрация и Lifecycle агентов реализованы
- Зависимости инжектятся корректно

#### IOutputRouter - ✅ Соответствие интерфейса
- Passthrough реализация соответствует MVP требованиям
- Подписка на topic OUTPUT

#### IApplication - ✅ Соответствие интерфейса
- Bootstrap в правильном порядке зависимостей
- Reset останавливает, очищает, перезапускает

#### HTTP API - ✅ Соответствие интерфейса
- POST /api/messages - реализован
- GET /api/trace-events - реализован с фильтрацией
- POST /api/control/reset - реализован
- POST /api/control/sim/start и /stop - реализованы

#### VS UI - ✅ Соответствие интерфейса
- Timeline отображает TraceEvents хронологически
- Polling клиент реализован корректно
- Управление SIM через кнопки

## Проверка качества кода

### Сильные стороны

1. **Архитектура:** Четкое разделение на модули, соблюдение зависимостей
2. **Asyncio:** Правильное использование `asyncio.create_task()` для фоновых задач
3. **EventBus:** Элегантная реализация pub/sub с параллельным вызовом подписчиков
4. **DialogueBuffer:** Правильная реализация вычисляемого буфера через фильтрацию по timestamp
5. **Error handling:** Ошибки LLM пробрасываются и обрабатываются в DialogueAgent
6. **Storage:** Параметризованные запросы защищают от SQL injection
7. **Tracker:** Двойной канал (подписка + track()) реализован элегантно
8. **VS UI:** Clean React код с правильной очисткой при размонтировании
9. **Type safety:** Использование Protocol для интерфейсов, dataclasses для моделей
10. **Integration tests:** Хороший интеграционный тест проверяет полный поток

### Проблемы

#### Критические

**1. Отсутствие unit-тестов (TC-14, AC-12)**
- **Файл:** Отсутствуют файлы `test_*.py` для компонентов
- **Описание:** Согласно ТЗ, для каждого компонента должны быть unit-тесты. Создан только интеграционный тест.
- **Влияние:** Невозможно проверить корректность работы отдельных компонентов изолированно. Риск регрессий при доработках.
- **Рекомендация:** Создать unit-тесты для:
  - `test_storage.py` - CRUD операции для всех сущностей
  - `test_event_bus.py` - подписка, публикация, множественные подписчики
  - `test_tracker.py` - track(), создание TraceEvents
  - `test_llm_provider.py` - mock API, проверка формата запроса/ответа
  - `test_dialogue_buffer.py` - добавление, фильтрация, очистка
  - `test_dialogue_agent.py` - handle_message, буферизация (с моком LLM)
  - `test_echo_agent.py` - подписка, обработка input, публикация output
  - `test_output_router.py` - подписка, доставка в DialogueAgent
  - `test_application.py` - порядок инициализации, reset

#### Важные

**2. Опечатки в коде (sgr_traces вместо sgr_traces)**
- **Файлы:**
  - `core/models/agents.py:22` - `sgr_traces` (правильно)
  - `core/storage/schema.sql:52` - `sgr_traces` (неправильно, column name)
  - `core/storage/storage.py:291,297` - `sgr_traces` (неправильно, поле в SQL)
  - `core/storage/storage.py:297,309,323` - `sgr_traces` (неправильно, доступ к полю)
- **Описание:** В Python модели используется `sgr_traces`, но в SQLite schema и коде доступа - `sgr_traces` (без 'r').
- **Влияние:** Код не будет работать - будет ошибка "no such column: sgr_traces" при попытке сохранить AgentState.
- **Рекомендация:** Переименовать колонку `sgr_traces` → `sgr_traces` в schema.sql и обновить все обращения в storage.py

**3. Опечатка в названии файла (tracing.py вместо tracing.py)**
- **Файл:** `core/models/tracing.py` (должен быть `tracing.py`)
- **Описание:** Название файла отличается от того, что импортируется в `__init__.py`
- **Влияние:** Импорт `from .tracing import TraceEvent` работает, но название файла запутывающее
- **Рекомендация:** Переименовать `tracing.py` → `tracing.py` для соответствия Python конвенциям (слова, начинающиеся с 'trac', обычно пишутся через 'c' до 'ing')

**4. Опечатки в SQL schema**
- **Файл:** `core/storage/schema.sql:6,13,22`
- **Описание:** Используется `NOT NULL` вместо `NOT NULL`
- **Влияние:** SQL синтаксическая ошибка при создании таблиц
- **Рекомендация:** Заменить `NOT NULL` на `NOT NULL` в строках:
  - Line 6: `name TEXT NOT NULL` → `name TEXT NOT NULL`
  - Line 13: `team_id TEXT NOT NULL` → `team_id TEXT NOT NULL`
  - Line 22: `role TEXT NOT NULL` → `role TEXT NOT NULL`

**5. Отсутствие проверки на существование пользователя в SIM**
- **Файл:** `sim/sim.py:83`
- **Описание:** `if i < len(messages_per_user[user_idx]):` - но messages_per_user это list of lists, индексация может выйти за границы
- **Влияние:** Возможен IndexError при запуске SIM
- **Рекомендация:** Добавить проверку границ или использовать `enumerate(messages_per_user[user_idx])`

#### Мелкие

**6. Использование `print()` вместо logging**
- **Файлы:** Множество файлов используют `print()` для логирования
- **Описание:** Не использует structured logging как указано в ТЗ
- **Рекомендация:** Заменить критичные `print()` на `logging.info/error/debug` с JSON formatter

**7. Отсутствие валидации event_type в Tracker**
- **Файл:** `core/tracker/tracker.py`
- **Описание:** Нет валидации что `event_type` из разрешенного списка
- **Рекомендация:** Добавить enum или список разрешенных event types

**8. Необработанные исключения в DialogueAgent._buffer_timer**
- **Файл:** `core/dialogue/agent.py:246`
- **Описание:** `except Exception as e:` просто печатает ошибку, но продолжает работать
- **Рекомендация:** Добавить logging вместо print

**9. Potential race condition in VS UI polling**
- **Файл:** `vs_ui/src/api/client.ts:68`
- **Описание:** Если запрос занимает больше времени чем interval, может начаться новый запрос
- **Рекомендация:** Добавить флаг `isPolling` для защиты от параллельных запросов (уже есть `polling`, но не проверяется в начале `poll()`)

**10. Отсутствие CHUNK size для полинга**
- **Файл:** `vs_ui/src/api/client.ts:75`
- **Описание:** Всегда берется `events[0].timestamp` для следующего запроса
- **Рекомендация:** Проверять что `events.length > 0` перед обновлением `lastTimestamp`

**11. Hardcoded URLs в VS UI**
- **Файлы:** `vs_ui/src/App.tsx:30,43`
- **Описание:** URLs hardcoded как `http://localhost:8000`
- **Рекомендация:** Использовать переменную окружения `VITE_API_URL` (уже есть в client.ts)

**12. Отсутствие обработки ошибок LLM в SIM**
- **Файл:** `sim/sim.py:116`
- **Описание:** При ошибке API просто печатается статус код, но не проверяется response content
- **Рекомендация:** Проверять `response.status_code` строго на 200

### Рекомендации

1. **Исправить опечатки в коде** (критично для работоспособности):
   - `sgr_traces` → `sgr_traces` в schema.sql и storage.py
   - `NOT NULL` → `NOT NULL` в schema.sql
   - Проверить все опечатки в SQL запросах

2. **Добавить unit-тесты** (критично для качества):
   - Минимум один тест на каждый публичный метод компонентов
   - Использовать pytest-asyncio для async тестов
   - Mock LLMProvider для тестов (не вызывать реальный API)

3. **Улучшить логирование**:
   - Заменить print() на logging module
   - Добавить JSON formatter для структурированных логов
   - Логировать ключевые события (start/stop компонентов)

4. **Улучшить типизацию**:
   - Добавить более строгие типы для возвращаемых значений
   - Использовать `typing.NamedTuple` или `TypedDict` для сложных структур

5. **Добавить валидацию**:
   - Валидировать входящие данные в API (Pydantic модели хорошо, но можно расширить)
   - Проверять что event_type из разрешенного списка
   - Валидировать формат timestamp в API

6. **Улучшить VS UI**:
   - Добавить индикатор загрузки во время полинга
   - Показывать ошибки пользователю
   - Добавить возможность фильтрации по event_type

7. **Добавить документацию**:
   - README.md с инструкциями по запуску
   - Комментарии к сложным алгоритмам (особенно `_buffer_timer`)
   - Docstrings для всех публичных методов

## Решение

**Действие:** Вернуть Analyst

**Обоснование:**
1. Критическая проблема с опечатками в SQL (`sgr_traces` vs `sgr_traces`, `NOT NULL`) должна быть исправлена Analyst в техническом задании
2. Отсутствие unit-тестов - это отклонение от ТЗ (TC-14, AC-12), требующее обновления плана
3. После исправления опечаток и добавления unit-тестов в план, задача может быть передана обратно Developer

**Обоснование возврата Analyst (а не Developer):**
- Опечатки в schema.sql - это фундаментальная проблема, которая блокирует работоспособность
- Unit-тесты отсутствуют полностью - это не недоработка существующего кода, а новая функциональность
- Аналитик должен обновить техническое задание с четким списком требуемых тестов

## Комментарий

Реализация демонстрирует хорошее понимание архитектуры и корректное использование asyncio. Сквозной поток работает, все компоненты связаны. Основные проблемы связаны с внимательностью к деталям (опечатки) и полнотой тестирования. После исправления критических проблем это будет солидная основа для следующих итераций.

**Особо стоит отметить:** Developer отметил в implementation_01.md что unit-тесты не создавались "по принципам разработчика", но task_brief и analysis четко требуют их (AC-12, TC-14). Это отклонение от ТЗ которое должно быть исправлено.
